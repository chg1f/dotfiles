#!/bin/bash

set -e

for arg in "$@"; do
	case $arg in
	--debug)
		echo "[!] Running in debug mode"
		# CHEZMOI_SCRIPTS_DEBUG_MODE=true
		set -x
		;;
	--fetch)
		CHEZMOI_SCRIPTS_COMMANDS="${CHEZMOI_SCRIPTS_COMMANDS}:fetch"
		;;
	--apply)
		CHEZMOI_SCRIPTS_COMMANDS="${CHEZMOI_SCRIPTS_COMMANDS}:apply"
		;;
	--commit)
		CHEZMOI_SCRIPTS_COMMANDS="${CHEZMOI_SCRIPTS_COMMANDS}:commit"
		;;
	--upload)
		CHEZMOI_SCRIPTS_COMMANDS="${CHEZMOI_SCRIPTS_COMMANDS}:upload"
		;;
	--help | *)
		echo "Usage: $0  [--help] [--debug] [--fetch] [--apply] [--commit] [--upload]"
		exit 0
		;;
	esac
done

need() { command -v "$1" >/dev/null 2>&1; }

for cmd in ${CHEZMOI_SCRIPTS_COMMANDS//:/ }; do
	case $cmd in
	# init)
	# 	echo "[!] Initializing ..."
	#
	# 	if command -v brew >/dev/null 2>&1; then
	# 		echo "[*] Installing Homebrew ..."
	# 		bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
	# 		if command -v chezmoi >/dev/null 2>&1; then
	# 			echo "[*] Installing chezmoi via Homebrew ..."
	# 			brew install chezmoi
	# 		fi
	# 	else
	# 		echo "[*] Homebrew is already installed."
	# 	fi
	#
	# 	if command -v chezmoi >/dev/null 2>&1; then
	# 		if [[ -z "$GITHUB_USERNAME" ]]; then
	# 			read -rp "Enter your GitHub username: " GITHUB_USERNAME
	# 		fi
	# 		chezmoi init --ssh "$GITHUB_USERNAME"
	# 	fi
	#
	# 	;;
	fetch)
		if need chezmoi; then
			echo "Fetching chezmoi updates ..."

			chezmoi update --init
		fi
		if need brew; then
			echo "[*] Fetching brew updates..."

			brew update
		fi
		;;
	apply)
		# TODO: init tpm zimfw

		if need chezmoi; then
			echo "[*] Applying chezmoi state ..."

			chezmoi apply --no-pager
		fi
		if need brew; then
			echo "[*] Applying brew packages ..."

			brew bundle || true
			brew upgrade
		fi
		if need zimfw; then
			echo "[*] Updating zimfw ..."

			zimfw update
		fi
		if [[ -x "$HOMEBREW_PREFIX/opt/tpm/share/tpm/bin/update_plugins" ]]; then
			echo "[*] Updating tmux plugins ..."

			"$HOMEBREW_PREFIX/opt/tpm/share/tpm/bin/update_plugins" all
		fi
		if need nvim; then
			echo "[*] Updating nvim plugins ..."

			nvim --headless "+Lazy! sync" "+qa"
		fi
		;;
	commit)
		echo "[!] Committing ..."

		if need brew; then
			echo "[*] Dumping brew packages ..."

			brew bundle dump --force --no-restart
		fi

		if need chezmoi; then
			echo "[*] Committing chezmoi state ..."

			chezmoi re-add --no-pager
		fi
		;;
	upload)
		echo "[!] Uploading ..."

		if need chezmoi; then
			echo "[*] Uploading chezmoi state ..."

			chezmoi git push origin main
		fi
		;;
	esac
done
